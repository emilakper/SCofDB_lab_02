# –°—Ç–∞—Ç—É—Å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç—ã ‚Ññ2

## ‚úÖ –ß—Ç–æ –≥–æ—Ç–æ–≤–æ

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ Docker –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (–∏–∑ lab_01)
- ‚úÖ Backend (FastAPI) - –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (–∏–∑ lab_01)
- ‚úÖ PostgreSQL - –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ (–∏–∑ lab_01)
- ‚úÖ –ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –ë–î (001_init.sql –∏–∑ lab_01)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —à–∞–±–ª–æ–Ω—ã
- ‚úÖ README.md - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫–æ–¥–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
- ‚úÖ REPORT.md - —à–∞–±–ª–æ–Ω –æ—Ç—á—ë—Ç–∞ —Å TODO
- ‚úÖ PaymentService - —Ñ–∞–π–ª —Å TODO –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- ‚úÖ –¢–µ—Å—Ç—ã - —à–∞–±–ª–æ–Ω—ã —Ç–µ—Å—Ç–æ–≤ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å

### 1. PaymentService (`backend/app/application/payment_service.py`)

**pay_order_unsafe()**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á—Ç–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –ë–ï–ó FOR UPDATE
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UPDATE orders SET status = 'paid'
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å INSERT –≤ order_status_history
- [ ] –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FOR UPDATE!
- [ ] –ù–ï –º–µ–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏!

**pay_order_safe()**
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å REPEATABLE READ —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å SELECT ... FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å UPDATE orders SET status = 'paid'
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å INSERT –≤ order_status_history
- [ ] –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FOR UPDATE!

**get_payment_history()**
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–ª–∞—Ç
- [ ] –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ order_id –∏ status = 'paid'

### 2. –¢–µ—Å—Ç—ã

**test_concurrent_payment_unsafe.py**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É db_session
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É test_order
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç, –∑–∞–ø—É—Å–∫–∞—é—â–∏–π –¥–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö pay_order_unsafe()
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –î–í–ï –∑–∞–ø–∏—Å–∏ 'paid' (race condition)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–≤–æ–¥: "‚ö†Ô∏è RACE CONDITION DETECTED!"
- [ ] –¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ü–†–û–•–û–î–ò–¢–¨

**test_concurrent_payment_safe.py**
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—ã (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ unsafe)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç, –∑–∞–ø—É—Å–∫–∞—é—â–∏–π –¥–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö pay_order_safe()
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –û–î–ù–ê –∑–∞–ø–∏—Å—å 'paid'
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ —É—Å–ø–µ—à–Ω–∞, –≤—Ç–æ—Ä–∞—è - –æ—à–∏–±–∫–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–≤–æ–¥: "‚úÖ RACE CONDITION PREVENTED!"
- [ ] –¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ü–†–û–•–û–î–ò–¢–¨

### 3. –û—Ç—á—ë—Ç REPORT.md

**–†–∞–∑–¥–µ–ª 1: –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**
- [ ] –û–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ —Ç–∞–∫–æ–µ race condition
- [ ] –ü–æ—á–µ–º—É READ COMMITTED –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç
- [ ] –ü—Ä–∏–≤–µ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏

**–†–∞–∑–¥–µ–ª 2: –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏**
- [ ] –û–ø–∏—Å–∞—Ç—å READ UNCOMMITTED
- [ ] –û–ø–∏—Å–∞—Ç—å READ COMMITTED
- [ ] –û–ø–∏—Å–∞—Ç—å REPEATABLE READ
- [ ] –û–ø–∏—Å–∞—Ç—å SERIALIZABLE
- [ ] –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

**–†–∞–∑–¥–µ–ª 3: –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**
- [ ] –ü–æ—á–µ–º—É REPEATABLE READ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
- [ ] –ó–∞—á–µ–º –Ω—É–∂–µ–Ω FOR UPDATE
- [ ] –ß—Ç–æ –±–µ–∑ FOR UPDATE –Ω–∞ REPEATABLE READ
- [ ] –†–∞–∑–Ω–∏—Ü–∞ FOR UPDATE –∏ FOR SHARE

**–†–∞–∑–¥–µ–ª 4: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞**
- [ ] –û–±–æ—Å–Ω–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä ISOLATION LEVEL
- [ ] –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
- [ ] –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

## üéØ –ì–ª–∞–≤–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å race condition –≤ –∫–æ–¥–µ –∏ —Ä–µ—à–∏—Ç—å –µ–≥–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –°–£–ë–î!**

–î–≤–∞ –º–µ—Ç–æ–¥–∞ –¥–æ–ª–∂–Ω—ã:
1. **pay_order_unsafe()** - –ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
2. **pay_order_safe()** - —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è REPEATABLE READ + FOR UPDATE

## üöÄ –ö–∞–∫ –Ω–∞—á–∞—Ç—å

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
cd lab_02
docker-compose up --build

# 2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å PaymentService
# –û—Ç–∫—Ä–æ–π—Ç–µ backend/app/application/payment_service.py
# –°–ª–µ–¥—É–π—Ç–µ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º

# 3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã
# –û—Ç–∫—Ä–æ–π—Ç–µ backend/app/tests/test_concurrent_payment_*.py
# –°–ª–µ–¥—É–π—Ç–µ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
cd backend
export PYTHONPATH=$(pwd)
pytest app/tests/test_concurrent_payment_unsafe.py -v -s
pytest app/tests/test_concurrent_payment_safe.py -v -s

# 5. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –æ—Ç—á—ë—Ç REPORT.md
```

## üìù –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫:

1. –ò–∑—É—á–∏—Ç–µ payment_service.py - —Ç–∞–º –ø–æ–¥—Ä–æ–±–Ω—ã–µ TODO
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ pay_order_unsafe() (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –ë–ï–ó –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ get_payment_history() (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
4. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ç–µ—Å—Ç test_concurrent_payment_unsafe.py
5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–∫–∞–∑ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã ‚ö†Ô∏è
6. –†–µ–∞–ª–∏–∑—É–π—Ç–µ pay_order_safe() (—Å REPEATABLE READ + FOR UPDATE)
7. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ç–µ—Å—Ç test_concurrent_payment_safe.py
8. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–∫–∞–∑ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ ‚úÖ
9. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Ç—á—ë—Ç REPORT.md

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# –¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ü–†–û–ô–¢–ò –∏ –ø–æ–∫–∞–∑–∞—Ç—å –¥–≤–æ–π–Ω—É—é –æ–ø–ª–∞—Ç—É
pytest app/tests/test_concurrent_payment_unsafe.py -v -s
# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# ‚ö†Ô∏è RACE CONDITION DETECTED!
# Order XXX was paid TWICE

# –¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ü–†–û–ô–¢–ò –∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω—É—é –æ–ø–ª–∞—Ç—É
pytest app/tests/test_concurrent_payment_safe.py -v -s
# –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
# ‚úÖ RACE CONDITION PREVENTED!
# Order XXX was paid only ONCE
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `README.md` - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
- `REPORT.md` - —à–∞–±–ª–æ–Ω –æ—Ç—á—ë—Ç–∞ —Å TODO
- `payment_service.py` - —Å–µ—Ä–≤–∏—Å —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ TODO
- `test_concurrent_payment_*.py` - —Ç–µ—Å—Ç—ã —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
